#!/u/sirsi/Unicorn/Bin/perl

@ckeysID = `cat objID940 | seltext -oCS 2>ckeysID.log`;

open(MATCH,">match940");
open(NO,">noMatch940");

foreach $ckeysID (@ckeysID)
  {
  chomp($ckeysID);
  ($ckey,$objID) = split/\|/,$ckeysID;
  $objID =~ s/\{940\}//;
  @lines = `grep $objID records`; 
  foreach $line1 (@lines)
    {
    chomp($line1);
    print MATCH "$ckey|$line1\n";
    }
  }

close(MATCH);

open(UPG, ">ckeysUpgraded");
@ckey008 = `cat match940 |selcatalog -iC -e008 -oCeS 2>/dev/null`;
foreach $ckey008 (@ckey008)
  {
  chomp($ckey008);
  ($ckey,$t008,$S) = split/\|/,$ckey008;
  ($one,$two,$three,$ldr17,$startDate,$endDate) = split/\^/,$S;
  $ldr17sym = substr($t008,17,1);
  if ($ldr17 eq "" && $ldr17sym ne "")
    {
    print UPG "$ckey\n";
    }
  elsif ($ldr17 eq "7" && $ldr17sym eq "z")
    {
    print UPG "$ckey\n";
    }
  else
    {
    ;
    }
  }

open(PDIFF, ">ckeysPubDiff");
foreach $ckey008 (@ckey008)
  {
  chomp($ckey008);
  ($ckey,$t008,$S) = split/\|/,$ckey008;
  ($one,$two,$three,$ldr17,$startDate,$endDate) = split/\^/,$S;
  $date1 = substr($t008,7,4);
  $date2 = substr($t008,11,4);
  $date1 =~ s/u/0/g;
  $date2 =~ s/u/9/g;
  $startDate =~ s/u/0/g;
  $endDate =~ s/u/9/g;

  #if ($endDate eq 9999)
  #  {
  #  $endDate = `date '+%Y'`;
  #  chomp($endDate);
  #  }

  if ($startDate < $date1 || $endDate > $date2)
    {
    print PDIFF "$ckey|$startDate|$date1|$endDate|$date2\n";
    }
  }

@ckeyBarLib = `cat match940 |selitem -iC -oCBy 2>/dev/null`;
push(@ckeyBarLib,"999");

$ckeyPrev = "0";
$grp = "";
$firstLine = "y";
open(HASITM,">ckeyHasUAINT");
open(NOITM,">ckeyNoUAINT");
foreach $ckeyBarLib (@ckeyBarLib)
  {
  chomp($ckeyBarLib);
  ($ckey,$bar,$lib) = split/\|/,$ckeyBarLib;
  if ($ckey eq $ckeyPrev || $firstLine eq "y")
    {
    push (@grp,$ckeyBarLib);
    $firstLine = "n";
    $ckeyPrev = $ckey;
    }
  else
    {
    $ckeyPrev = $ckey;
    $foundUAINT = "n";
    $size = @grp;
    foreach $item (@grp)
      {
      chomp($item);
      next if $item eq "";
      ($ckey,$bar,$lib) = split/\|/,$item;
      if ($lib eq "UAINTERNET")
        {
        $foundUAINT = "y";
        push (@ckeyBar,"$ckey");
        }
      else
        {
        #print "$ckey,$bar,$lib,$foundUAINT\n";
        }
      }
    @grp = "";
    push (@grp,$ckeyBarLib);
    if ($foundUAINT eq "n")
      {
      print NOITM "$ckey\n";
      }
    else
      {
      print HASITM "$ckey\n"
      }
    }
  }

@ckey856 = `cat match940 |prtentry -e856 -oCe 2>/dev/null`;
open(NO856,">ckeyNo856");
foreach $ckeyBar (@ckeyBar)
  {
  chomp($ckeyBar);
  $foundUA856 = "n";
  foreach $line (@ckey856)
    {
    chomp($line);
    next if $line eq "";
    ($ckey856,$stuff) = split/\|/,$line;
    if ($ckey856 eq $ckeyBar)
      {
      if ($line =~ /University of Alberta Access/)
       {
        #print "$ckey856 - yes\n";
        $foundUA856 = "y";
        last;
        }
      }
    }

  if ($foundUA856 eq "n")
    {
    print NO856 "$ckey\n";
    }
  }

@recs0 = `grep "0 records" ckeysID.log`;

foreach $line2 (@recs0)
  {
  chomp($line2);
  $line2 =~ s/0 records found for #.*: "//;
  $line2 =~ s/".NM02.//;
  $line2 =~ s/ //g;
  @lines2 = `grep $line2 records 2>/dev/null`;
  foreach $rec (@lines2)
    {
    chomp($rec);
    print NO "$rec\n";
    }
  }
close(NO);
